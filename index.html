<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>ShopperControl PRO</title>

<style>
body { font-family: Arial; background:#f4f4f4; padding:20px;}
h1 { color:#8e44ad; }
.card { background:white; padding:15px; margin-bottom:15px; border-radius:8px; box-shadow:0 2px 5px rgba(0,0,0,0.1);}
input, select { padding:8px; margin:5px 0; width:100%;}
button { padding:8px; background:#8e44ad; color:white; border:none; cursor:pointer; margin-top:5px;}
button:hover { background:#732d91; }
.info { font-weight:bold; }
</style>
</head>
<body>

<h1>üõçÔ∏è Shopper Control PRO</h1>

<!-- CLIENTES -->
<div class="card">
<h2>‚ûï Agregar Cliente</h2>
<input type="text" id="clienteNombre" placeholder="Nombre">
<input type="text" id="clienteTelefono" placeholder="Tel√©fono">
<button onclick="agregarCliente()">Guardar Cliente</button>
</div>

<!-- NUEVA VENTA -->
<div class="card">
<h2>üõí Nueva Venta</h2>

<select id="clienteSelect"></select>

<input type="text" id="descripcion" placeholder="Descripci√≥n del producto">

<input type="number" id="precioUSA" placeholder="Precio USA">

<select id="tipoComision">
<option value="online">Online 15%</option>
<option value="peque√±o">Peque√±o $10</option>
<option value="mediano">Mediano $15</option>
<option value="grande">Grande $25</option>
</select>

<button onclick="calcularBase()">Calcular Base</button>

<hr>

<label><b>Precio Final que di al cliente (CRC)</b></label>
<input type="number" id="precioFinal" oninput="recalcularFinal()">

<div id="resultado"></div>

<button onclick="guardarVenta()">Guardar Venta</button>

</div>

<!-- VENTAS GUARDADAS -->
<div class="card">
<h2>üìä Ventas Realizadas</h2>
<div id="ventasLista"></div>
<div id="resumen"></div>
</div>

<script>

let tasaImpuesto = 0.065;
let tipoCambio = 520;

let clientes = JSON.parse(localStorage.getItem("clientes")) || [];
let ventas = JSON.parse(localStorage.getItem("ventas")) || [];

let invertidoGlobal = 0;

/* ================= GUARDAR DATOS ================= */

function guardarDatos(){
    try {
        localStorage.setItem("clientes", JSON.stringify(clientes));
        localStorage.setItem("ventas", JSON.stringify(ventas));
        console.log("Clientes guardados:", clientes);
        console.log("Ventas guardadas:", ventas);
        console.log("Datos guardados en localStorage correctamente.");
    } catch (error) {
        console.error("Error al guardar en localStorage:", error);
        alert("Hubo un problema al guardar los datos. Por favor, revise el almacenamiento local.");
    }
}

/* ================= CLIENTES ================= */

function agregarCliente(){
    let nombre = document.getElementById("clienteNombre").value.trim();
    let telefono = document.getElementById("clienteTelefono").value.trim();

    if(!nombre) {
        alert("Ingrese un nombre v√°lido.");
        return;
    }

    clientes.push({nombre, telefono});
    guardarDatos();
    cargarClientes();

    // Limpiar los campos despu√©s de guardar el cliente
    document.getElementById("clienteNombre").value = "";
    document.getElementById("clienteTelefono").value = "";

    alert("Cliente guardado correctamente.");
}

function cargarClientes(){
    let select = document.getElementById("clienteSelect");
    select.innerHTML = "";

    clientes = JSON.parse(localStorage.getItem("clientes")) || []; // Asegurarse de cargar los datos actualizados
    console.log("Clientes cargados:", clientes);

    if (clientes.length === 0) {
        select.innerHTML = `<option value="">No hay clientes disponibles</option>`;
        return;
    }

    clientes.forEach((c, i) => {
        select.innerHTML += `<option value="${i}">${c.nombre}</option>`;
    });
}

/* ================= CALCULO BASE ================= */

function calcularBase(){

    let precioUSA = parseFloat(document.getElementById("precioUSA").value);
    let tipo = document.getElementById("tipoComision").value;

    if(!precioUSA) return alert("Ingrese Precio USA");

    let tax = precioUSA * tasaImpuesto;
    let subtotal = precioUSA + tax;

    let comision = 0;
    if (tipo === "online") comision = subtotal * 0.15;
    if (tipo === "peque√±o") comision = 10;
    if (tipo === "mediano") comision = 15;
    if (tipo === "grande") comision = 25;

    let totalUSD = subtotal + comision;

    let invertidoCRC = subtotal * tipoCambio;
    let sugeridoCRC = totalUSD * tipoCambio;

    invertidoGlobal = invertidoCRC;

    document.getElementById("precioFinal").value = sugeridoCRC.toFixed(2);

    recalcularFinal();
}

/* ================= RECALCULAR SEGUN PRECIO FINAL ================= */

function recalcularFinal(){

    let precioFinal = parseFloat(document.getElementById("precioFinal").value);
    if(!precioFinal || invertidoGlobal === 0) return;

    let gananciaReal = precioFinal - invertidoGlobal;
    let abono50 = precioFinal * 0.5;
    let margen = (gananciaReal / precioFinal) * 100;

    document.getElementById("resultado").innerHTML = `
    <div class="card info">
    üí∞ Invertido: ‚Ç°${invertidoGlobal.toFixed(2)}<br>
    üè∑Ô∏è Precio Final: ‚Ç°${precioFinal.toFixed(2)}<br>
    üíµ Ganancia Real: ‚Ç°${gananciaReal.toFixed(2)}<br>
    üìä Margen: ${margen.toFixed(2)}%<br>
    üîí 50% para apartar: ‚Ç°${abono50.toFixed(2)}
    </div>
    `;
}

/* ================= GUARDAR VENTA ================= */

function guardarVenta(){
    let clienteIndex = document.getElementById("clienteSelect").value;
    let descripcion = document.getElementById("descripcion").value.trim();
    let precioUSA = parseFloat(document.getElementById("precioUSA").value);
    let precioFinal = parseFloat(document.getElementById("precioFinal").value);

    if(clienteIndex === "" || isNaN(clienteIndex) || !descripcion || isNaN(precioUSA) || isNaN(precioFinal)){
        alert("Complete todos los datos antes de guardar la venta.");
        console.error("Datos incompletos:", { clienteIndex, descripcion, precioUSA, precioFinal });
        return;
    }

    let ganancia = precioFinal - invertidoGlobal;

    ventas.push({
        cliente: clientes[clienteIndex].nombre,
        descripcion,
        invertido: invertidoGlobal,
        precioFinal,
        ganancia
    });

    guardarDatos();
    mostrarVentas();

    // Limpiar los campos despu√©s de guardar la venta
    document.getElementById("descripcion").value = "";
    document.getElementById("precioUSA").value = "";
    document.getElementById("precioFinal").value = "";

    console.log("Venta guardada correctamente:", ventas[ventas.length - 1]);
    alert("Venta guardada correctamente.");
}

/* ================= BORRAR VENTA ================= */

function borrarVenta(index) {
    if (confirm("¬øEst√° seguro de que desea borrar esta venta?")) {
        ventas.splice(index, 1); // Eliminar la venta del array
        guardarDatos(); // Guardar los cambios en localStorage
        mostrarVentas(); // Actualizar la lista de ventas
        alert("Venta borrada correctamente.");
    }
}

/* ================= EDITAR ABONO ================= */

function editarAbono(index) {
    if (index < 0 || index >= ventas.length) {
        alert("El √≠ndice de la venta es inv√°lido.");
        console.error("√çndice inv√°lido para editar abono:", index);
        return;
    }

    let nuevaAbono = parseFloat(prompt("Ingrese el nuevo abono (‚Ç°):"));

    if (isNaN(nuevaAbono) || nuevaAbono < 0) {
        alert("Por favor, ingrese un valor v√°lido para el abono.");
        return;
    }

    let venta = ventas[index];
    if (venta) {
        venta.abono50 = nuevaAbono; // Actualizar el abono en la venta
        guardarDatos(); // Guardar los cambios en localStorage
        mostrarVentas(); // Actualizar la lista de ventas
        alert("Abono actualizado correctamente.");
    } else {
        alert("No se encontr√≥ la venta para editar.");
        console.error("Venta no encontrada para el √≠ndice:", index);
    }
}

/* ================= EDITAR VENTA ================= */

function editarVenta(index) {
    let nuevaAbono = parseFloat(prompt("Ingrese el nuevo abono (‚Ç°):"));
    let nuevaFecha = prompt("Ingrese la nueva fecha (YYYY-MM-DD):", new Date().toISOString().split('T')[0]);

    if (isNaN(nuevaAbono) || nuevaAbono < 0) {
        alert("Por favor, ingrese un valor v√°lido para el abono.");
        return;
    }

    if (!/\d{4}-\d{2}-\d{2}/.test(nuevaFecha)) {
        alert("Por favor, ingrese una fecha v√°lida en el formato YYYY-MM-DD.");
        return;
    }

    let venta = ventas[index];
    if (venta) {
        venta.abono50 = nuevaAbono; // Actualizar el abono en la venta
        venta.fecha = nuevaFecha; // Actualizar la fecha en la venta
        guardarDatos(); // Guardar los cambios en localStorage
        mostrarVentas(); // Actualizar la lista de ventas
        alert("Venta actualizada correctamente.");
    } else {
        alert("No se encontr√≥ la venta para editar.");
    }
}

/* ================= MOSTRAR VENTAS ================= */

function mostrarVentas(){
    let lista = document.getElementById("ventasLista");
    lista.innerHTML = ""; // Limpiar la lista antes de renderizar

    ventas = JSON.parse(localStorage.getItem("ventas")) || []; // Asegurarse de cargar los datos actualizados
    console.log("Ventas cargadas:", ventas);

    if (ventas.length === 0) {
        lista.innerHTML = `<div class="card">No hay ventas registradas.</div>`;
        document.getElementById("resumen").innerHTML = "";
        return;
    }

    // Agrupar ventas por cliente
    let ventasPorCliente = {};
    ventas.forEach((v, index) => {
        if (!ventasPorCliente[v.cliente]) {
            ventasPorCliente[v.cliente] = {
                totalComprado: 0,
                totalAbonado: 0,
                totalPendiente: 0,
                compras: []
            };
        }

        let precioFinal = parseFloat(v.precioFinal) || 0;
        let abono = parseFloat(v.abono50) || 0; // Los abonos siempre inician en 0
        let sugeridoAbono = precioFinal * 0.5; // Mostrar el 50% como sugerencia
        let saldoPendiente = precioFinal - abono;

        ventasPorCliente[v.cliente].totalComprado += precioFinal;
        ventasPorCliente[v.cliente].totalAbonado += abono;
        ventasPorCliente[v.cliente].totalPendiente += saldoPendiente;
        ventasPorCliente[v.cliente].compras.push({ ...v, sugeridoAbono, index });
    });

    // Mostrar ventas agrupadas por cliente
    for (let cliente in ventasPorCliente) {
        let clienteData = ventasPorCliente[cliente];

        lista.innerHTML += `
        <div class="card">
        <h3>Cliente: ${cliente}</h3>
        <b>Total Comprado:</b> ‚Ç°${clienteData.totalComprado.toFixed(2)}<br>
        <b>Total Abonado:</b> ‚Ç°${clienteData.totalAbonado.toFixed(2)}<br>
        <b>Total Pendiente:</b> ‚Ç°${clienteData.totalPendiente.toFixed(2)}<br>
        <hr>
        <h4>Detalle de Compras:</h4>
        `;

        clienteData.compras.forEach((v) => {
            let precioFinal = parseFloat(v.precioFinal) || 0;
            let abono = parseFloat(v.abono50) || 0; // Los abonos siempre inician en 0
            let sugeridoAbono = v.sugeridoAbono || (precioFinal * 0.5);
            let saldoPendiente = precioFinal - abono;

            lista.innerHTML += `
            <div class="card">
            <b>Producto:</b> ${v.descripcion || "Sin descripci√≥n"}<br>
            <b>Invertido:</b> ‚Ç°${(parseFloat(v.invertido) || 0).toFixed(2)}<br>
            <b>Precio Final:</b> ‚Ç°${precioFinal.toFixed(2)}<br>
            <b>Ganancia:</b> ‚Ç°${(parseFloat(v.ganancia) || 0).toFixed(2)}<br>
            <b>Abono:</b> ‚Ç°${abono.toFixed(2)}<br>
            <b>Saldo Pendiente:</b> ‚Ç°${saldoPendiente.toFixed(2)}<br>
            <b>Abono Sugerido (50%):</b> ‚Ç°${sugeridoAbono.toFixed(2)}<br>
            <b>Fecha:</b> ${v.fecha || "Sin fecha"}<br>
            <button onclick="borrarVenta(${v.index})">üóëÔ∏è Borrar</button>
            <button onclick="editarAbono(${v.index})">‚úèÔ∏è Editar</button>
            </div>
            `;
        });

        lista.innerHTML += `</div>`;
    }

    document.getElementById("resumen").innerHTML = ""; // Limpiar el resumen global
}

// Asegurarse de que el c√≥digo se ejecute despu√©s de que el DOM est√© completamente cargado
window.onload = function() {
    window.agregarCliente = agregarCliente;
    window.cargarClientes = cargarClientes;
    window.calcularBase = calcularBase;
    window.recalcularFinal = recalcularFinal;
    window.guardarVenta = guardarVenta;
    window.mostrarVentas = mostrarVentas;

    // Inicializar clientes y ventas al cargar la p√°gina
    cargarClientes();
    mostrarVentas();
};
</script>

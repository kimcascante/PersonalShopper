<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>ShopperControl</title>
<style>
body { font-family: Arial; background:#f4f4f4; padding:20px;}
h2 { color:#444;}
.card { background:white; padding:15px; margin-bottom:15px; border-radius:8px;}
input, select { padding:5px; margin:5px 0; width:100%;}
button { padding:8px; background:#8e44ad; color:white; border:none; cursor:pointer;}
.warning { color:red; font-weight:bold;}
.success { color:green; font-weight:bold;}
</style>
</head>
<body>

<h1>üõçÔ∏è Shopper Control</h1>

<div class="card">
<h2>‚ûï Agregar Cliente</h2>
<input type="text" id="clienteNombre" placeholder="Nombre">
<input type="text" id="clienteTelefono" placeholder="Tel√©fono">
<button onclick="agregarCliente()">Guardar Cliente</button>
</div>

<div class="card">
<h2>üõí Nueva Venta</h2>

<select id="clienteSelect"></select>

<input type="number" id="precioUSA" placeholder="Precio USA">

<select id="tipoComision">
<option value="online">Online 15%</option>
<option value="peque√±o">Peque√±o $10</option>
<option value="mediano">Mediano $15</option>
<option value="grande">Grande $25</option>
</select>

<input type="number" id="abonado" placeholder="Monto Abonado (CRC)">

<button onclick="calcularVenta()">Calcular</button>
<button onclick="guardarVenta()">Guardar Venta</button>

<p id="mensaje"></p>

</div>

<div class="card">
<h2>üìä Ventas</h2>
<div id="ventasLista"></div>
</div>

<script>

let tasaImpuesto = 0.065;
let tipoCambio = 520;

let clientes = JSON.parse(localStorage.getItem("clientes")) || [];
let ventas = JSON.parse(localStorage.getItem("ventas")) || [];
let editandoIndex = null;

function guardarDatos() {
    localStorage.setItem("clientes", JSON.stringify(clientes));
    localStorage.setItem("ventas", JSON.stringify(ventas));
}

function agregarCliente() {
    let nombre = document.getElementById("clienteNombre").value;
    let telefono = document.getElementById("clienteTelefono").value;

    if (!nombre) return alert("Ingrese nombre");

    clientes.push({nombre, telefono});
    guardarDatos();
    cargarClientes();
    alert("Cliente agregado");
}

function cargarClientes() {
    let select = document.getElementById("clienteSelect");
    let filtro = document.getElementById("filtroCliente");

    select.innerHTML = "";
    filtro.innerHTML = `<option value="todos">Todos los clientes</option>`;

    clientes.forEach((c, index) => {
        select.innerHTML += `<option value="${index}">${c.nombre}</option>`;
        filtro.innerHTML += `<option value="${c.nombre}">${c.nombre}</option>`;
    });
}

function calcularCostos(precioUSA, tipo) {

    let tax = precioUSA * tasaImpuesto;
    let subtotal = precioUSA + tax;

    let comision = 0;

    if (tipo === "online") comision = subtotal * 0.15;
    if (tipo === "peque√±o") comision = 10;
    if (tipo === "mediano") comision = 15;
    if (tipo === "grande") comision = 25;

    let totalUSD = subtotal + comision;
    let totalCRC = totalUSD * tipoCambio;
    let invertidoCRC = subtotal * tipoCambio;

    return { totalCRC, invertidoCRC };
}

function guardarVenta() {

    let clienteIndex = document.getElementById("clienteSelect").value;
    if (clienteIndex === "") return alert("Seleccione cliente");

    let descripcion = document.getElementById("descripcion").value;
    let precioUSA = parseFloat(document.getElementById("precioUSA").value);
    let tipo = document.getElementById("tipoComision").value;
    let abonado = parseFloat(document.getElementById("abonado").value) || 0;
    let precioVendido = parseFloat(document.getElementById("precioVendido").value) || 0;

    if (!precioUSA) return alert("Ingrese precio USA");

    let { totalCRC, invertidoCRC } = calcularCostos(precioUSA, tipo);

    let pendiente = precioVendido - abonado;
    let ganancia = precioVendido - invertidoCRC;

    let ventaData = {
        cliente: clientes[clienteIndex].nombre,
        descripcion,
        invertidoCRC,
        precioVendido,
        abonado,
        pendiente,
        ganancia,
        estado: pendiente > 0 ? "Pendiente" : "Pagado"
    };

    if (editandoIndex !== null) {
        ventas[editandoIndex] = ventaData;
        editandoIndex = null;
    } else {
        ventas.push(ventaData);
    }

    guardarDatos();
    mostrarVentas();
    limpiarFormulario();

    document.getElementById("mensaje").innerHTML =
        "<span class='success'>‚úÖ Venta guardada correctamente</span>";
}

function editarVenta(index) {
    let v = ventas[index];

    document.getElementById("descripcion").value = v.descripcion;
    document.getElementById("precioVendido").value = v.precioVendido;
    document.getElementById("abonado").value = v.abonado;

    editandoIndex = index;
}

function mostrarVentas() {

    let filtro = document.getElementById("filtroCliente").value;
    let lista = document.getElementById("ventasLista");
    lista.innerHTML = "";

    let totalInvertido = 0;
    let totalVendido = 0;
    let totalGanancia = 0;

    ventas.forEach((v, index) => {

        if (filtro !== "todos" && v.cliente !== filtro) return;

        totalInvertido += v.invertidoCRC;
        totalVendido += v.precioVendido;
        totalGanancia += v.ganancia;

        lista.innerHTML += `
        <div class="card">
        <b>Cliente:</b> ${v.cliente}<br>
        <b>Producto:</b> ${v.descripcion || "Sin descripci√≥n"}<br>
        <b>Invertido:</b> ‚Ç°${v.invertidoCRC.toFixed(2)}<br>
        <b>Vendido:</b> ‚Ç°${v.precioVendido.toFixed(2)}<br>
        <b>Ganancia:</b> ‚Ç°${v.ganancia.toFixed(2)}<br>
        <b>Abonado:</b> ‚Ç°${v.abonado.toFixed(2)}<br>
        <b>Pendiente:</b> ‚Ç°${v.pendiente.toFixed(2)}<br>
        <b>Estado:</b> ${v.estado}<br><br>
        <button onclick="editarVenta(${index})">Editar</button>
        <button onclick="borrarVentaSeleccionada(${index})">Borrar</button>
        </div>
        `;
    });

    document.getElementById("analisis").innerHTML = `
    <div class="card">
    <h3>üìà An√°lisis General</h3>
    Total Invertido: ‚Ç°${totalInvertido.toFixed(2)}<br>
    Total Vendido: ‚Ç°${totalVendido.toFixed(2)}<br>
    Ganancia Total: ‚Ç°${totalGanancia.toFixed(2)}
    </div>
    `;
}

function borrarVentaSeleccionada(index) {
    if (confirm("¬øBorrar esta venta?")) {
        ventas.splice(index, 1);
        guardarDatos();
        mostrarVentas();
    }
}

function borrarVentas() {
    if (confirm("¬øBorrar todas las ventas?")) {
        ventas = [];
        guardarDatos();
        mostrarVentas();
    }
}

function limpiarFormulario() {
    document.getElementById("descripcion").value = "";
    document.getElementById("precioUSA").value = "";
    document.getElementById("precioVendido").value = "";
    document.getElementById("abonado").value = "";
}

cargarClientes();
mostrarVentas();

</script>

    
</html>

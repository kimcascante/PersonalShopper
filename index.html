<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>ShopperControl PRO</title>

<style>
body { 
    font-family: Arial; 
    background:#f4f4f4; 
    padding:20px;
}

h1 { color:#8e44ad; }

.card { 
    background:white; 
    padding:15px; 
    margin-bottom:15px; 
    border-radius:8px;
    box-shadow:0 2px 5px rgba(0,0,0,0.1);
}

input, select { 
    padding:8px; 
    margin:5px 0; 
    width:100%;
}

button { 
    padding:8px; 
    background:#8e44ad; 
    color:white; 
    border:none; 
    cursor:pointer;
    margin-top:5px;
}

button:hover {
    background:#732d91;
}

.warning { color:red; font-weight:bold;}
.success { color:green; font-weight:bold;}
</style>

</head>
<body>

<h1>üõçÔ∏è Shopper Control PRO</h1>

<!-- ================= CLIENTES ================= -->

<div class="card">
<h2>‚ûï Agregar Cliente</h2>
<input type="text" id="clienteNombre" placeholder="Nombre">
<input type="text" id="clienteTelefono" placeholder="Tel√©fono">
<button onclick="agregarCliente()">Guardar Cliente</button>
</div>

<!-- ================= NUEVA VENTA ================= -->

<div class="card">
<h2>üõí Nueva Venta</h2>

<select id="clienteSelect"></select>

<input type="text" id="descripcion" placeholder="Descripci√≥n del producto">

<input type="number" id="precioUSA" placeholder="Precio USA">

<select id="tipoComision">
<option value="online">Online 15%</option>
<option value="peque√±o">Peque√±o $10</option>
<option value="mediano">Mediano $15</option>
<option value="grande">Grande $25</option>
</select>

<input type="number" id="precioVendido" placeholder="Precio Vendido (CRC)">

<input type="number" id="abonado" placeholder="Monto Abonado (CRC)">

<button onclick="guardarVenta()">Guardar / Actualizar Venta</button>

<p id="mensaje"></p>

</div>

<!-- ================= VENTAS ================= -->

<div class="card">
<h2>üìä Ventas</h2>

<select id="filtroCliente" onchange="mostrarVentas()">
<option value="todos">Todos los clientes</option>
</select>

<button onclick="borrarVentas()">Borrar Todas</button>

<div id="ventasLista"></div>
<div id="analisis"></div>

</div>

<script>

let tasaImpuesto = 0.065;
let tipoCambio = 520;

let clientes = JSON.parse(localStorage.getItem("clientes")) || [];
let ventas = JSON.parse(localStorage.getItem("ventas")) || [];
let editandoIndex = null;

function guardarDatos() {
    localStorage.setItem("clientes", JSON.stringify(clientes));
    localStorage.setItem("ventas", JSON.stringify(ventas));
}

/* ================= CLIENTES ================= */

function agregarCliente() {
    let nombre = document.getElementById("clienteNombre").value;
    let telefono = document.getElementById("clienteTelefono").value;

    if (!nombre) {
        alert("Ingrese el nombre del cliente");
        return;
    }

    clientes.push({nombre, telefono});
    guardarDatos();
    cargarClientes();
    alert("Cliente agregado correctamente");

    document.getElementById("clienteNombre").value = "";
    document.getElementById("clienteTelefono").value = "";
}

function cargarClientes() {
    let select = document.getElementById("clienteSelect");
    let filtro = document.getElementById("filtroCliente");

    select.innerHTML = "";
    filtro.innerHTML = `<option value="todos">Todos los clientes</option>`;

    clientes.forEach((c, index) => {
        select.innerHTML += `<option value="${index}">${c.nombre}</option>`;
        filtro.innerHTML += `<option value="${c.nombre}">${c.nombre}</option>`;
    });
}

/* ================= CALCULOS ================= */

function calcularCostos(precioUSA, tipo) {

    let tax = precioUSA * tasaImpuesto;
    let subtotal = precioUSA + tax;

    let comision = 0;

    if (tipo === "online") comision = subtotal * 0.15;
    if (tipo === "peque√±o") comision = 10;
    if (tipo === "mediano") comision = 15;
    if (tipo === "grande") comision = 25;

    let totalUSD = subtotal + comision;
    let totalCRC = totalUSD * tipoCambio;
    let invertidoCRC = subtotal * tipoCambio;

    return { totalCRC, invertidoCRC };
}

/* ================= GUARDAR / EDITAR ================= */

function guardarVenta() {

    let clienteIndex = document.getElementById("clienteSelect").value;
    if (clienteIndex === "") {
        alert("Seleccione un cliente");
        return;
    }

    let descripcion = document.getElementById("descripcion").value;
    let precioUSA = parseFloat(document.getElementById("precioUSA").value);
    let tipo = document.getElementById("tipoComision").value;
    let abonado = parseFloat(document.getElementById("abonado").value) || 0;
    let precioVendido = parseFloat(document.getElementById("precioVendido").value);

    if (!precioUSA || !precioVendido) {
        alert("Debe ingresar Precio USA y Precio Vendido");
        return;
    }

    let { invertidoCRC } = calcularCostos(precioUSA, tipo);

    let pendiente = precioVendido - abonado;
    let ganancia = precioVendido - invertidoCRC;

    let ventaData = {
        cliente: clientes[clienteIndex].nombre,
        descripcion,
        precioUSA,
        invertidoCRC,
        precioVendido,
        abonado,
        pendiente,
        ganancia,
        estado: pendiente > 0 ? "Pendiente" : "Pagado"
    };

    if (editandoIndex !== null) {
        ventas[editandoIndex] = ventaData;
        editandoIndex = null;
    } else {
        ventas.push(ventaData);
    }

    guardarDatos();
    mostrarVentas();
    limpiarFormulario();

    document.getElementById("mensaje").innerHTML =
        "<span class='success'>‚úÖ Venta guardada correctamente</span>";
}

function editarVenta(index) {
    let v = ventas[index];

    document.getElementById("descripcion").value = v.descripcion;
    document.getElementById("precioUSA").value = v.precioUSA;
    document.getElementById("precioVendido").value = v.precioVendido;
    document.getElementById("abonado").value = v.abonado;

    editandoIndex = index;
    window.scrollTo({ top: 0, behavior: 'smooth' });
}

/* ================= MOSTRAR VENTAS ================= */

function mostrarVentas() {

    let filtro = document.getElementById("filtroCliente").value;
    let lista = document.getElementById("ventasLista");
    lista.innerHTML = "";

    let totalInvertido = 0;
    let totalVendido = 0;
    let totalGanancia = 0;

    ventas.forEach((v, index) => {

        if (filtro !== "todos" && v.cliente !== filtro) return;

        totalInvertido += v.invertidoCRC;
        totalVendido += v.precioVendido;
        totalGanancia += v.ganancia;

        lista.innerHTML += `
        <div class="card">
        <b>Cliente:</b> ${v.cliente}<br>
        <b>Producto:</b> ${v.descripcion || "Sin descripci√≥n"}<br>
        <b>Invertido:</b> ‚Ç°${v.invertidoCRC.toFixed(2)}<br>
        <b>Vendido:</b> ‚Ç°${v.precioVendido.toFixed(2)}<br>
        <b>Ganancia:</b> ‚Ç°${v.ganancia.toFixed(2)}<br>
        <b>Abonado:</b> ‚Ç°${v.abonado.toFixed(2)}<br>
        <b>Pendiente:</b> ‚Ç°${v.pendiente.toFixed(2)}<br>
        <b>Estado:</b> ${v.estado}<br><br>
        <button onclick="editarVenta(${index})">Editar</button>
        <button onclick="borrarVentaSeleccionada(${index})">Borrar</button>
        </div>
        `;
    });

    document.getElementById("analisis").innerHTML = `
    <div class="card">
    <h3>üìä An√°lisis General</h3>
    <b>Total Invertido:</b> ‚Ç°${totalInvertido.toFixed(2)}<br>
    <b>Total Vendido:</b> ‚Ç°${totalVendido.toFixed(2)}<br>
    <b>Ganancia Total:</b> ‚Ç°${totalGanancia.toFixed(2)}
    </div>
    `;
}

/* ================= BORRAR ================= */

function borrarVentaSeleccionada(index) {
    if (confirm("¬øDesea borrar esta venta?")) {
        ventas.splice(index, 1);
        guardarDatos();
        mostrarVentas();
    }
}

function borrarVentas() {
    if (confirm("¬øBorrar TODAS las ventas?")) {
        ventas = [];
        guardarDatos();
        mostrarVentas();
    }
}

/* ================= LIMPIAR ================= */

function limpiarFormulario() {
    document.getElementById("descripcion").value = "";
    document.getElementById("precioUSA").value = "";
    document.getElementById("precioVendido").value = "";
    document.getElementById("abonado").value = "";
}

/* ================= INIT ================= */

cargarClientes();
mostrarVentas();

</script>

</body>
</html>

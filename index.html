<script>

let tasaImpuesto = 0.065;
let tipoCambio = 520;

let clientes = JSON.parse(localStorage.getItem("clientes")) || [];
let ventas = JSON.parse(localStorage.getItem("ventas")) || [];
let editandoIndex = null;

function guardarDatos() {
    localStorage.setItem("clientes", JSON.stringify(clientes));
    localStorage.setItem("ventas", JSON.stringify(ventas));
}

/* =========================
   CLIENTES
========================= */

function agregarCliente() {
    let nombre = document.getElementById("clienteNombre").value;
    let telefono = document.getElementById("clienteTelefono").value;

    if (!nombre) {
        alert("Ingrese el nombre del cliente");
        return;
    }

    clientes.push({nombre, telefono});
    guardarDatos();
    cargarClientes();
    alert("Cliente agregado correctamente");

    document.getElementById("clienteNombre").value = "";
    document.getElementById("clienteTelefono").value = "";
}

function cargarClientes() {
    let select = document.getElementById("clienteSelect");
    let filtro = document.getElementById("filtroCliente");

    if (!select || !filtro) return;

    select.innerHTML = "";
    filtro.innerHTML = `<option value="todos">Todos los clientes</option>`;

    clientes.forEach((c, index) => {
        select.innerHTML += `<option value="${index}">${c.nombre}</option>`;
        filtro.innerHTML += `<option value="${c.nombre}">${c.nombre}</option>`;
    });
}

/* =========================
   CALCULOS
========================= */

function calcularCostos(precioUSA, tipo) {

    let tax = precioUSA * tasaImpuesto;
    let subtotal = precioUSA + tax;

    let comision = 0;

    if (tipo === "online") comision = subtotal * 0.15;
    if (tipo === "pequeÃ±o") comision = 10;
    if (tipo === "mediano") comision = 15;
    if (tipo === "grande") comision = 25;

    let totalUSD = subtotal + comision;
    let totalCRC = totalUSD * tipoCambio;
    let invertidoCRC = subtotal * tipoCambio;

    return { totalCRC, invertidoCRC };
}

/* =========================
   GUARDAR / EDITAR VENTA
========================= */

function guardarVenta() {

    let clienteIndex = document.getElementById("clienteSelect").value;
    if (clienteIndex === "") {
        alert("Seleccione un cliente");
        return;
    }

    let descripcion = document.getElementById("descripcion").value;
    let precioUSA = parseFloat(document.getElementById("precioUSA").value);
    let tipo = document.getElementById("tipoComision").value;
    let abonado = parseFloat(document.getElementById("abonado").value) || 0;
    let precioVendido = parseFloat(document.getElementById("precioVendido").value);

    if (!precioUSA || !precioVendido) {
        alert("Debe ingresar Precio USA y Precio Vendido");
        return;
    }

    let { totalCRC, invertidoCRC } = calcularCostos(precioUSA, tipo);

    let pendiente = precioVendido - abonado;
    let ganancia = precioVendido - invertidoCRC;

    let ventaData = {
        cliente: clientes[clienteIndex].nombre,
        descripcion,
        precioUSA,
        invertidoCRC,
        precioVendido,
        abonado,
        pendiente,
        ganancia,
        estado: pendiente > 0 ? "Pendiente" : "Pagado"
    };

    if (editandoIndex !== null) {
        ventas[editandoIndex] = ventaData;
        editandoIndex = null;
    } else {
        ventas.push(ventaData);
    }

    guardarDatos();
    mostrarVentas();
    limpiarFormulario();

    document.getElementById("mensaje").innerHTML =
        "<span class='success'>âœ… Venta guardada correctamente</span>";
}

/* =========================
   EDITAR VENTA
========================= */

function editarVenta(index) {
    let v = ventas[index];

    document.getElementById("descripcion").value = v.descripcion;
    document.getElementById("precioUSA").value = v.precioUSA;
    document.getElementById("precioVendido").value = v.precioVendido;
    document.getElementById("abonado").value = v.abonado;

    editandoIndex = index;

    window.scrollTo({ top: 0, behavior: 'smooth' });
}

/* =========================
   MOSTRAR VENTAS + ANALISIS
========================= */

function mostrarVentas() {

    let filtro = document.getElementById("filtroCliente")?.value || "todos";
    let lista = document.getElementById("ventasLista");
    lista.innerHTML = "";

    let totalInvertido = 0;
    let totalVendido = 0;
    let totalGanancia = 0;

    ventas.forEach((v, index) => {

        if (filtro !== "todos" && v.cliente !== filtro) return;

        totalInvertido += v.invertidoCRC;
        totalVendido += v.precioVendido;
        totalGanancia += v.ganancia;

        lista.innerHTML += `
        <div class="card">
        <b>Cliente:</b> ${v.cliente}<br>
        <b>Producto:</b> ${v.descripcion || "Sin descripciÃ³n"}<br>
        <b>Invertido:</b> â‚¡${v.invertidoCRC.toFixed(2)}<br>
        <b>Vendido:</b> â‚¡${v.precioVendido.toFixed(2)}<br>
        <b>Ganancia:</b> â‚¡${v.ganancia.toFixed(2)}<br>
        <b>Abonado:</b> â‚¡${v.abonado.toFixed(2)}<br>
        <b>Pendiente:</b> â‚¡${v.pendiente.toFixed(2)}<br>
        <b>Estado:</b> ${v.estado}<br><br>
        <button onclick="editarVenta(${index})">Editar</button>
        <button onclick="borrarVentaSeleccionada(${index})">Borrar</button>
        </div>
        `;
    });

    document.getElementById("analisis").innerHTML = `
    <div class="card">
    <h3>ðŸ“Š AnÃ¡lisis General</h3>
    <b>Total Invertido:</b> â‚¡${totalInvertido.toFixed(2)}<br>
    <b>Total Vendido:</b> â‚¡${totalVendido.toFixed(2)}<br>
    <b>Ganancia Total:</b> â‚¡${totalGanancia.toFixed(2)}
    </div>
    `;
}

/* =========================
   BORRAR
========================= */

function borrarVentaSeleccionada(index) {
    if (confirm("Â¿Desea borrar esta venta?")) {
        ventas.splice(index, 1);
        guardarDatos();
        mostrarVentas();
    }
}

function borrarVentas() {
    if (confirm("Â¿Borrar TODAS las ventas?")) {
        ventas = [];
        guardarDatos();
        mostrarVentas();
    }
}

/* =========================
   LIMPIAR
========================= */

function limpiarFormulario() {
    document.getElementById("descripcion").value = "";
    document.getElementById("precioUSA").value = "";
    document.getElementById("precioVendido").value = "";
    document.getElementById("abonado").value = "";
}

/* =========================
   INIT
========================= */

cargarClientes();
mostrarVentas();

</script>
